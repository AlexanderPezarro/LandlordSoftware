generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      String   @default("VIEWER")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model Property {
  id            String   @id @default(uuid())
  name          String
  street        String
  city          String
  county        String
  postcode      String
  propertyType  String   @map("property_type")
  purchaseDate  DateTime? @map("purchase_date")
  purchasePrice Float?    @map("purchase_price")
  status        String
  notes         String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  leases       Lease[]
  transactions Transaction[]
  events       Event[]

  @@map("properties")
}

model Tenant {
  id                    String   @id @default(uuid())
  firstName             String   @map("first_name")
  lastName              String   @map("last_name")
  email                 String
  phone                 String
  emergencyContactName  String?  @map("emergency_contact_name")
  emergencyContactPhone String?  @map("emergency_contact_phone")
  status                String
  notes                 String?
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  leases    Lease[]

  @@map("tenants")
}

model Lease {
  id                      String    @id @default(uuid())
  propertyId              String    @map("property_id")
  tenantId                String    @map("tenant_id")
  startDate               DateTime  @map("start_date")
  endDate                 DateTime? @map("end_date")
  monthlyRent             Float     @map("monthly_rent")
  securityDepositAmount   Float     @map("security_deposit_amount")
  securityDepositPaidDate DateTime? @map("security_deposit_paid_date")
  status                  String
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")

  property     Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@map("leases")
}

model Transaction {
  id                String    @id @default(uuid())
  propertyId        String    @map("property_id")
  leaseId           String?   @map("lease_id")
  type              String
  category          String
  amount            Float
  transactionDate   DateTime  @map("transaction_date")
  description       String
  bankTransactionId String?   @unique @map("bank_transaction_id")
  isImported        Boolean   @default(false) @map("is_imported")
  importedAt        DateTime? @map("imported_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  property        Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  lease           Lease?            @relation(fields: [leaseId], references: [id], onDelete: SetNull)
  bankTransaction BankTransaction?

  @@map("transactions")
}

model Event {
  id            String    @id @default(uuid())
  propertyId    String    @map("property_id")
  eventType     String    @map("event_type")
  title         String
  description   String?
  scheduledDate DateTime  @map("scheduled_date")
  completed     Boolean   @default(false)
  completedDate DateTime? @map("completed_date")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("events")
}

model Document {
  id         String   @id @default(uuid())
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  fileName   String   @map("file_name")
  filePath   String   @map("file_path")
  fileType   String   @map("file_type")
  fileSize   Int      @map("file_size")
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  @@map("documents")
}

model BankAccount {
  id             String    @id @default(uuid())
  accountId      String    @unique @map("account_id")
  accountName    String    @map("account_name")
  accountType    String    @map("account_type")
  provider       String    @default("monzo")
  accessToken    String    @map("access_token")
  refreshToken   String?   @map("refresh_token")
  tokenExpiresAt DateTime? @map("token_expires_at")
  syncEnabled    Boolean   @default(true) @map("sync_enabled")
  syncFromDate   DateTime  @map("sync_from_date")
  lastSyncAt     DateTime? @map("last_sync_at")
  lastSyncStatus String    @default("never_synced") @map("last_sync_status")
  webhookId      String?   @unique @map("webhook_id")
  webhookUrl     String?   @map("webhook_url")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  bankTransactions BankTransaction[]
  matchingRules    MatchingRule[]
  syncLogs         SyncLog[]

  @@map("bank_accounts")
}

model BankTransaction {
  id                   String    @id @default(uuid())
  bankAccountId        String    @map("bank_account_id")
  externalId           String    @map("external_id")
  amount               Float
  currency             String    @default("GBP")
  description          String
  counterpartyName     String?   @map("counterparty_name")
  reference            String?
  merchant             String?
  category             String?
  transactionDate      DateTime  @map("transaction_date")
  settledDate          DateTime? @map("settled_date")
  importedAt           DateTime  @default(now()) @map("imported_at")
  transactionId        String?   @unique @map("transaction_id")
  pendingTransactionId String?   @unique @map("pending_transaction_id")

  bankAccount        BankAccount          @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  transaction        Transaction?         @relation(fields: [transactionId], references: [id])
  pendingTransaction PendingTransaction?

  @@unique([bankAccountId, externalId])
  @@index([bankAccountId, transactionDate])
  @@map("bank_transactions")
}

model MatchingRule {
  id            String   @id @default(uuid())
  bankAccountId String?  @map("bank_account_id")
  priority      Int
  enabled       Boolean  @default(true)
  name          String
  conditions    String
  propertyId    String?  @map("property_id")
  type          String?
  category      String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  bankAccount BankAccount? @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)

  @@index([bankAccountId, priority])
  @@map("matching_rules")
}

model PendingTransaction {
  id                String    @id @default(uuid())
  bankTransactionId String    @unique @map("bank_transaction_id")
  propertyId        String?   @map("property_id")
  leaseId           String?   @map("lease_id")
  type              String?
  category          String?
  transactionDate   DateTime  @map("transaction_date")
  description       String
  createdAt         DateTime  @default(now()) @map("created_at")
  reviewedAt        DateTime? @map("reviewed_at")
  reviewedBy        String?   @map("reviewed_by")

  bankTransaction BankTransaction @relation(fields: [bankTransactionId], references: [id], onDelete: Cascade)

  @@map("pending_transactions")
}

model SyncLog {
  id                   String    @id @default(uuid())
  bankAccountId        String    @map("bank_account_id")
  syncType             String    @map("sync_type")
  status               String
  startedAt            DateTime  @default(now()) @map("started_at")
  completedAt          DateTime? @map("completed_at")
  transactionsFetched  Int       @default(0) @map("transactions_fetched")
  transactionsSkipped  Int       @default(0) @map("transactions_skipped")
  transactionsMatched  Int       @default(0) @map("transactions_matched")
  transactionsPending  Int       @default(0) @map("transactions_pending")
  errorMessage         String?   @map("error_message")
  errorDetails         String?   @map("error_details")
  webhookEventId       String?   @map("webhook_event_id")

  bankAccount BankAccount @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)

  @@index([bankAccountId, startedAt])
  @@map("sync_logs")
}

model TransactionAuditLog {
  id            String   @id @default(uuid())
  transactionId String   @map("transaction_id")
  userId        String   @map("user_id")
  field         String
  oldValue      String?  @map("old_value")
  newValue      String?  @map("new_value")
  changedAt     DateTime @default(now()) @map("changed_at")

  @@index([transactionId, changedAt])
  @@map("transaction_audit_logs")
}
